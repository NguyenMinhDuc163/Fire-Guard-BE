name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Lấy mã nguồn
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. Cài đặt SSH key để kết nối server
    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.5.3
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    # 3. Deploy ứng dụng trên server qua SSH
    - name: Deploy using Dockerfile
      run: |
        ssh -o StrictHostKeyChecking=no nguyenduc163@20.2.33.95 << 'EOF'
          set -e  # Dừng nếu có lỗi

          # Chuyển đến thư mục dự án
          cd /home/nguyenduc163/Fire-Guard-BE

          # Pull mã nguồn mới nhất
          echo "Pulling latest code from GitHub..."
          git pull origin main

          # Build Docker image từ Dockerfile
          echo "Building Docker image..."
          docker build -t fire_guard_be .

          # Kiểm tra và dừng container cũ (nếu có)
          echo "Stopping and removing old container..."
          docker stop fire_guard_be || true
          docker rm fire_guard_be || true

          # Chạy container mới từ image vừa build
          echo "Running new container..."
          docker run -d -p 3000:3000 --name fire_guard_be fire_guard_be

          echo "Deployment completed successfully!"
        EOF
